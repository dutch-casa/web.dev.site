"use client"

import { useRef, useEffect, useState } from "react"

type Vec3 = readonly [number, number, number]
type Mat4 = readonly [number, number, number, number, number, number, number, number, number, number, number, number, number, number, number, number]

type RenderWidth = 80
type RenderHeight = 40

interface Texture {
  readonly grid: readonly string[][]
  readonly width: number
  readonly height: number
}

interface Camera {
  readonly radius: number
  readonly alpha: number
  readonly beta: number
  readonly matrix: Mat4
  readonly position: Vec3
}

interface GlobeConfig {
  readonly radius: number
  readonly angle: number
  readonly texture: Texture
}

interface RenderContext {
  readonly camera: Camera
  readonly globe: GlobeConfig
  readonly light: Vec3
  readonly asciiPalette: readonly string[]
  readonly renderWidth: RenderWidth
  readonly renderHeight: RenderHeight
}

interface Ray {
  readonly origin: Vec3
  readonly direction: Vec3
}

interface SphereIntersection {
  readonly distance: number
  readonly point: Vec3
  readonly normal: Vec3
}

type MaybeIntersection = SphereIntersection | null

const ASCII_PALETTE: readonly string[] = " .:;'`\"^,i!l~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$".split("")

const EARTH_TEXTURE_DATA = `............................................................................................................................................................................................................................................................................................................
............................................................................................................................................................................................................................................................................................................
......................................................................................H..........................HHHHHHHHHHHHHHHH...........................................................................................................................................................................
......................................................................HHHHH...ggggg@@@@@@@@@gggggg...gggggggggg@@@@@@@@@@@@@@@@@@ggg......HH................................................HHHHH..HHH.HHHHH.......................HHHH.....................................................................
........................................................HHH...H.HHHHH.g.g@g@gg@g@@@@@@@g.......g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g..H.........................g.ggggg...HH................HHH....HHHH..........................H...g..H..HH..............................................................
................................................H........HHHHHHHH...HH..H.g..ggggggg.H....H.gggggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g............................H...H.HHH..............................HHHHHHH....................HHHHHHHgggg.....HH....................HHHH...............................
..............................................H...........HH..HH.H.g.Hgg.gg.ggg.ggg.HH...............H.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H............................................................H.gg.HH...............HHHHHggggg@@@@@@@@@@@@ggggg.HHH.....HH........HH.....H.HHHH........................
HH.................H.........................Hgggg.g@@ggggg.g@g.HH.gg.gg.H.g@@gg@@ggg@g.HHH.............g@@@@@@@@@@@@@@@@@@@@@@@@g@g.............................................................Hg@gH........Hggg.HgH.g.ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gggg@@@@g..HHHHHH.gggg....HH......................H
H...........HH.gggg@ggggggg.......HHHHH....g......HH.ggg@@@@@ggggHHH..ggg.HH...@@g....g@@@@gg............ggg@@@@@@@@@@@@@@@@@@@@g..H..............................HHH..ggggggggg..HHH.........HH..HHHHH....HHHg@@@..@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg@@@@@@@@@@@@@@@@@gggggg........H......HH
ggggHHHH...H.gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gggggg@@@ggggg@@g@@@@@g.g@@g...H...g@@@@gg..H......g@@@@@@@@@@@@@@@g.HHH..........H.........................g@@@@@@@@@@@@@@@ggggg.HHHg.Hgggg@ggg@g@@@@@@g@@@g.@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
HHH.gg.H..H.gggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg.gg.HH....H.g@@@@...H.......H.@@@@@@@@@gHHH...........gggggggH...................H.g@@@@@@gH.g@@@@@@@@....gg@g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.
.......HH..H.ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H...HH.H.HH..H.H..gg..H..........Hg@@@@@gH.................HHH........H.........H.gg@@@@@@g.HHgg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg@@gg@@@@@@@ggg..H
...........H.gg@@@@@@@ggggg...ggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@H.............g@@@@ggH..H.............HH..gH.......................................g@@@@@@@@@gH.Hgggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggggggg@@g.H....ggg.....H......
...............HH.gg.g.H...........Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.HHH..........@@@@@@ggg@@gH...............................................g.H.....H.....g@@@HH....g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg.H.......HH..H.gg@gH.............
.............HHH.HH..H...............H.gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg..HHH.HH.@@@@@@@@@@@@@.HH.........................................H.gg@........Hgg.gg..HHHg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H.............H@@@@gH..............
.........HHH............................H.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.g@@@@@@@@@@@@@@@@@gH.....................................Hg@gH.g@g...H..g@@ggggg@g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gggg..H..........g@.H................
...........................................gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg@@@@@@@@@@gggggg..g......................................HHH.H.gg.g.gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Hgg.........H.H..................
............................................H.gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggggHHH.Hgggg.........................................H.ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.gH..............................
...............................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g@g......HHH...........................................@@@@@@@@@@@gg@@@@@@@@@@@@g..g@g.g@@@@@@@g..H.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH...H..............................
...............................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.HH.HH............................................H...HH.@@@@ggg...@g..gg@@@@@@@@gH..HHH.H.gg@@@@....g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggggH...Hgg.HH...........................
...............................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg.H...................................................@@@@@@@g......g.H....HHg@@ggg@....ggg.HHHg@@@@@gH.H.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg@@@@@gH.......HgHH..............................
..............................................Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.....................................................g@@@@@@g..H........HHgH.Hg@gH.g@@@@@@@@@@@@@@@@@@H...@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gHH.HHg@gH.........gH...............................
................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.......................................................HH.g...HH......gg..HH....H..HHH.g..gg.@@@@@@@@@@@g...@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H..Hg@g...HHHgg@.................................
...................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H........................................................H.@ggg@@@@@@@@@gH.................H..@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.......H.gg.g.HH.................................
.....................................................@gg@@@@@@@@@@@@@@@@@@@@@@@@@@.H..........................................................g@@@@@@@@@@@@@@@@@gggHH.Hggg.HHHHHHHH@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@H........H.......................................
.....................................................Hg.g@@@@@@@@@@@@gg...g.HHH..@..........................................................H.@@@@@@@@@@@@@@@@@@@@@@@gg@@@@@@@@@@@@@@@@@@@.Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.................................................
......................................................Hg.Hg@@@@@@@@@@H...........g@H.......................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..g@@@@@@@@@gHHHgggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..................................................
..........................................................HHg@@@@@@@g................H....................................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@HHg@@@@@@@@@@gHH.gHHHH.HHH.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gHHH................................................
..........................................................H...@@@@@@g..........HHH...H..................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g...@@@@@@@@@@@@@@@g.........g@g@@@@@@@@@ggH.....@@@@@@@@@@gHHgH.........................................................
...................H..........................................g@@@@@@......@@.......H..HH..H............................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...@@@@@@@@@@@@@@..........HH.@@@@@@@@@ggH.....@@@@@@@@@@gHHH.........g................................................
...............................................................H..g@@@gggg@@g........H..HH.HH.HH.H.......................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.Hg@@@@@@@@gg.H............H@@@@@@@g.H........@g@@@@@@@gHHH.........g................................................
....................................................................HHHH.@@@ggggH.................H...............................H....Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.H.@@@@@g.H..................@@@@@H..........HH..@@@@@@@@..........g.................................................
..........................................................................HH.g@@..........HH............................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.g.HHH.....................g@@@g..........H...H@.gg@@@@@H............H.............................................
...............................................................................@........g@.gg..H...H....................................H.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...ggg.....................H.H.g.............Hg....H.........HH.....gH...............................................
..................................................................................g..gg@@@g@@@@@@@@g.......................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.....................H.H.g.............Hg....H.........HH.....gH...............................................
......................................................................................@@@@@@@@@@@@@@@g...H..................................H.g@@ggg@g..HHg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.........................H............HHH..g............g.H.H.H.H............................................
.....................................................................................g@@@@@@@@@@@@@@@@@@@@@....................................H...........HHH@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g..........................................g.Hg@H......H.@@@H...................................................
...................................................................................Hg@@@@@@@@@@@@@@@@@@@@@@@H................................................H@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH...........................................Hg@ggg...Hgg@@@@@..HHHH..gH..........................................
.........................................................................HH.......H@@@@@@@@@@@@@@@@@@@@@@@@g@gg.H.............................................@@@@@@@@@@@@@@@@@@@@@@@@@@gH..............................................H.@@gHH..g@@@@@......HH...H.g..HHH......H...........................
..................................................................................H@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggg.H.......................................Hg@@@@@@@@@@@@@@@@@@@@@@@H.................................................HHg@@.H..H......g.gH..HHHH.Hg.g@@@@g.H......H......................
...................................................................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg.......................................g@@@@@@@@@@@@@@@@@@@@@g.....................................................H...HHHHH....HHHH........HH.Hg@@@@@g.HH.H..H....................
...................................................................................Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.......................................H@@@@@@@@@@@@@@@@@@@@@@........................................................HHH...HHHHHHHHH.H...H.......gggH.g..H....HHHHH...............
.....................................................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..........................................g@@@@@@@@@@@@@@@@@@@@@..................................................................HH.HH....HHH............HHH.......HH...............
......................................................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.........................................Hg@@@@@@@@@@@@@@@@@@@@@g.......................................................................H...g@@gg....@...............................
........................................................................................g@@@@@@@@@@@@@@@@@@@@@@@@@@@@...........................................g@@@@@@@@@@@@@@@@@@@@@@g...H.g@g.............................................................Hg@gg@@@@@.H..H@@gH.................HH........H
.................................................................................................H.g@@@@@@@@@@@@@@@@@@@@@@@@@H.........................................H@@@@@@@@@@@@@@@@@@@@g.H...H@@@@H...........................................................Hg@@@@@@@@@@@@ggg@@@g..................H........H
............................................................................................@@@@@@@@@@@@@@@@@@@@@@@@............................................Hg@@@@@@@@@@@@@@@@@H......H@@@g.......................................................HH..g@@@@@@@@@@@@@@@@@@@@@g.H............H............
...........................................................................................g@@@@@@@@@@@@@@@@@@@@ggg..............................................H@@@@@@@@@@@@@@@@@.......g@@g......................................................Hg@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.............H...........
...........................................................................................g@@@@@@@@@@@@@@@@@g.H..................................................g@@@@@@@@@@@@@@g.H......HggH.......................................................@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH......................
..........................................................................................H@@@@@@@@@@@@@@@@@@.....................................................Hg@@@@@@@@@@@@@H..................................................................H@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g......................
...........................................................................................@@@@@@@@@@@@@@@@@.......................................................Hg@@@@@@@@@@gH....................................................................H@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g......................
..........................................................................................g@@@@@@@@@@@@@@@gH........................................................H@@@@@@@@g........................................................................g@@@@@@ggg..HH.g@@@@@@@@@@@@@@gH......................
.........................................................................................H@@@@@@@@@@@ggggH............................................................g....HH..........................................................................gg.HHHH..........gg@@@@@@@@@gH.................H.....
........................................................................................Hg@@@@@@@@@@@@..................................................................................................................................................................H..@@@@@@ggH..................H..HH.
........................................................................................H@@@@@@@@@...H.....................................................................................................................................................................HH.H.HH......................@.H.
.........................................................................................g@@@@@g..............................................................................................................................................................................Hgg...................Hg.H....
.........................................................................................g@@@@ggH..............................................................................................................................................................................H.H...............H.gg.H.....
........................................................................................@@@@@g....................................................................................................................................................................................................g.H.......
.......................................................................................g@@@@@g.................................................................................................................H............................................................................................
.......................................................................................g@@@@gH.....HHH......................................................................................................................................................................................................
.......................................................................................H.ggg@.H.....H.......................................................................................................................................................................................................
..........................................................................................HH..H.............................................................................................................................................................................................................
............................................................................................................................................................................................................................................................................................................
............................................................................................................................................................................................................................................................................................................
...................................................................................................HHHHH....................................................................................................................................................................................................
...............................................................................................H.g.HHHH..........................................................................................HHHH....................................HHHH.....HHH.......................................................
............................................................................................H.gg.H.......................................................................................HHH...g@@@@@gg........H.......HHH..gggggggggggggg@@@@gggg@@@ggggggggggggg@@@@@@gggggg..H..H..H.....................
.......................................................................................HHHgg..@@@g.H............................................H..H....HHHHHHHHHHH.HH.HHHHHHHHH.gg....g@@@@@@@@@@@@@@@@@@@@@@gg.HH..gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg@gggg.HHHHHH..........
................................................................HH....HHHHHHH......H..H...ggg.@@@@@......................................HH.g@gg@gg@ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@...g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gg.........
............................H.H..HHH........gg..g.g.g.g...HHHHHH..g@@@@@@@@@@@@ggg@@@gg@@@@@@@@@gg.H................................HHH.g@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g..H...........
..................H...HH..ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.g...HHH...............HH.........H...gggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gH.HHH.........
.............H.HH..H....gg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@gggggHH..H.H.HH..HH......H.g@@@@g.....H...ggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@g.HHHH...........
..............HH...HH.ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggg@gggg....H...HH......HHH.gggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@..HH............
...HH........ggggggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggg@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ggggg.....
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@`

const EARTH_TEXTURE: Texture = (() => {
  const lines = EARTH_TEXTURE_DATA.split("\n").filter(line => line.length > 0)
  return {
    grid: lines.map(line => line.split("")),
    width: lines[0]?.length ?? 0,
    height: lines.length,
  }
})()

const createCamera = (radius: number, alpha: number, beta: number): Camera => {
  const sinA = Math.sin(alpha)
  const cosA = Math.cos(alpha)
  const sinB = Math.sin(beta)
  const cosB = Math.cos(beta)

  const x = radius * cosA * cosB
  const y = radius * sinA * cosB
  const z = radius * sinB

  const matrix: Mat4 = [
    -sinA, cosA, 0, 0,
    cosA * sinB, sinA * sinB, -cosB, 0,
    cosA * cosB, sinA * cosB, sinB, 0,
    x, y, z, 1,
  ]

  return { radius, alpha, beta, matrix, position: [x, y, z] as const }
}

const vec3 = (x: number, y: number, z: number): Vec3 => [x, y, z] as const

const vec3Dot = (a: Vec3, b: Vec3): number => a[0] * b[0] + a[1] * b[1] + a[2] * b[2]

const vec3Magnitude = (v: Vec3): number => Math.sqrt(vec3Dot(v, v))

const vec3Normalize = (v: Vec3): Vec3 => {
  const len = vec3Magnitude(v)
  return len === 0 ? v : [v[0] / len, v[1] / len, v[2] / len] as const
}

const vec3Sub = (a: Vec3, b: Vec3): Vec3 => [a[0] - b[0], a[1] - b[1], a[2] - b[2]] as const

const vec3Add = (a: Vec3, b: Vec3): Vec3 => [a[0] + b[0], a[1] + b[1], a[2] + b[2]] as const

const vec3Scale = (v: Vec3, scalar: number): Vec3 => [v[0] * scalar, v[1] * scalar, v[2] * scalar] as const

const vec3RotateX = (v: Vec3, theta: number): Vec3 => {
  const sinTheta = Math.sin(theta)
  const cosTheta = Math.cos(theta)
  return [v[0], v[1] * cosTheta - v[2] * sinTheta, v[1] * sinTheta + v[2] * cosTheta] as const
}

const mat4TransformVec3 = (v: Vec3, m: Mat4): Vec3 => {
  const x = v[0] * m[0] + v[1] * m[4] + v[2] * m[8] + m[12]
  const y = v[0] * m[1] + v[1] * m[5] + v[2] * m[9] + m[13]
  const z = v[0] * m[2] + v[1] * m[6] + v[2] * m[10] + m[14]
  return [x, y, z] as const
}

const clamp = (x: number, min: number, max: number): number => {
  if (x < min) return min
  if (x > max) return max
  return x
}

const raySphereIntersect = (ray: Ray, sphereRadius: number): MaybeIntersection => {
  const dotUO = vec3Dot(ray.direction, ray.origin)
  const discriminant = dotUO * dotUO - vec3Dot(ray.origin, ray.origin) + sphereRadius * sphereRadius

  if (discriminant < 0) return null

  const distance = -Math.sqrt(discriminant) - dotUO
  const point = vec3Add(ray.origin, vec3Scale(ray.direction, distance))
  const normal = vec3Normalize(point)

  return { distance, point, normal }
}

const textureCoords = (point: Vec3, radius: number, angle: number, texWidth: number, texHeight: number): { x: number; y: number } => {
  const rotated = vec3RotateX(point, 0)
  const phi = -rotated[2] / radius / 2 + 0.5
  let theta = Math.atan2(rotated[1], rotated[0]) / Math.PI + 0.5 + angle / 2 / Math.PI
  theta -= Math.floor(theta)

  return {
    x: Math.floor(theta * texWidth),
    y: Math.floor(phi * texHeight),
  }
}

const calculateLuminance = (normal: Vec3, light: Vec3): number => {
  const lightDir = vec3Normalize(vec3Sub(light, normal))
  const dotProduct = vec3Dot(normal, lightDir)
  return clamp(5 * dotProduct + 0.5, 0, 1)
}

const mapToAscii = (luminance: number, palette: readonly string[]): string => {
  const index = Math.floor(luminance * (palette.length - 1))
  return palette[Math.min(index, palette.length - 1)]
}

const renderFrame = (context: RenderContext): readonly string[][] => {
  const { camera, globe, light, asciiPalette, renderWidth, renderHeight } = context
  const { radius, angle, texture } = globe

  const matrix: string[][] = Array(renderHeight).fill(null).map(() => Array(renderWidth).fill(" "))

  for (let yi = 0; yi < renderHeight; yi++) {
    for (let xi = 0; xi < renderWidth; xi++) {
      const u = mat4TransformVec3(
        vec3(
          -((xi - renderWidth / 2) / (renderWidth / 2) + 0.5),
          ((yi - renderHeight / 2) / (renderHeight / 2) + 0.5),
          -1,
        ),
        camera.matrix,
      )
      const direction = vec3Normalize(vec3Sub(u, camera.position))

      const intersection = raySphereIntersect(
        { origin: camera.position, direction },
        radius,
      )

      if (!intersection) continue

      const { point, normal } = intersection

      const coords = textureCoords(point, radius, angle, texture.width, texture.height)
      const texChar = texture.grid[coords.y]?.[coords.x]

      if (texChar !== " " && texChar !== undefined) {
        const luminance = calculateLuminance(normal, light)
        matrix[yi][xi] = mapToAscii(luminance, asciiPalette)
      }
    }
  }

  return matrix
}

const renderContext = (angle: number): RenderContext => ({
  camera: createCamera(2, 0, 0),
  globe: { radius: 1, angle, texture: EARTH_TEXTURE },
  light: [0, 999999, 0] as const,
  asciiPalette: ASCII_PALETTE,
  renderWidth: 80,
  renderHeight: 40,
})

interface AsciiGlobeProps {
  className?: string
}

function AsciiGlobe({ className }: AsciiGlobeProps) {
  const [asciiText, setAsciiText] = useState("")
  const frameRef = useRef<number>(0)
  const angleRef = useRef(0)

  useEffect(() => {
    const animate = () => {
      angleRef.current += 0.005
      const context = renderContext(angleRef.current)
      const matrix = renderFrame(context)
      const lines = matrix.map(row => row.join("")).reverse()
      setAsciiText(lines.join("\n"))
      frameRef.current = requestAnimationFrame(animate)
    }

    animate()

    return () => {
      cancelAnimationFrame(frameRef.current)
    }
  }, [])

  return (
    <div className={className}>
      <pre className="size-full flex items-center justify-center overflow-hidden font-mono text-[2.5vmin] md:text-[1.8vmin] leading-[0.55em] text-[rgb(32,220,128)] select-none whitespace-pre">
        {asciiText}
      </pre>
    </div>
  )
}

export { AsciiGlobe }
